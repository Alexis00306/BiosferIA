<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Reconocimiento Específico - Flora y Fauna</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: 2em auto;
        text-align: center;
      }
      #resultado {
        margin-top: 20px;
        text-align: left;
      }
      img {
        max-width: 100%;
        height: auto;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <h1>Reconocimiento Específico de Flora y Fauna</h1>
    <p>Sube una imagen y detectaremos la especie lo más específica posible.</p>

    <input type="file" id="imagenInput" accept="image/*" />
    <button id="btnAnalizar" disabled>Analizar Imagen</button>

    <div id="resultado"></div>

    <script>
      const API_KEY = "AIzaSyBV9M7KOEjza-_gXT1Q_lxkofnXhQuMYoI"; // Reemplaza con tu clave válida

      const imagenInput = document.getElementById("imagenInput");
      const btnAnalizar = document.getElementById("btnAnalizar");
      const resultadoDiv = document.getElementById("resultado");

      let base64Image = "";

      const palabrasClaveFlora = [
        "plant",
        "tree",
        "flower",
        "grass",
        "moss",
        "fungus",
        "leaf",
        "bush",
        "weed",
        "flora",
        "herb",
        "shrub",
        "fungi",
        "algae",
        "planta",
        "árbol",
        "flor",
        "hierba",
        "musgo",
        "hongo",
        "hoja",
        "arbusto",
        "maleza",
        "arbusto",
        "hongos",
        "algas",
      ];

      const palabrasClaveFauna = [
        "animal",
        "bird",
        "mammal",
        "fish",
        "reptile",
        "amphibian",
        "insect",
        "arachnid",
        "fauna",
        "animal",
        "ave",
        "mamífero",
        "pez",
        "reptil",
        "anfibio",
        "insecto",
        "arácnido",
        "serpent",
        "snake",
      ];

      function determinarTipo(texto) {
        texto = texto.toLowerCase();
        if (palabrasClaveFlora.some((p) => texto.includes(p))) return "Flora";
        if (palabrasClaveFauna.some((p) => texto.includes(p))) return "Fauna";
        return null;
      }

      function determinarTipoDesdeExtracto(extract) {
        if (!extract) return null;
        const texto = extract.toLowerCase();

        const floraKeys = [
          "planta",
          "árbol",
          "flor",
          "hierba",
          "musgo",
          "hongo",
          "algas",
          "arbusto",
          "vegetal",
          "flora",
        ];
        const faunaKeys = [
          "animal",
          "ave",
          "mamífero",
          "pez",
          "reptil",
          "anfibio",
          "insecto",
          "serpiente",
          "araña",
          "invertebrado",
          "mariposa",
          "crustáceo",
          "lagarto",
          "rata",
          "ratón",
          "cangrejo",
          "tiburón",
          "perro",
          "gato",
          "lagarto",
          "amphibian",
          "reptile",
          "bird",
          "mammal",
          "fish",
          "insect",
        ];

        for (const f of faunaKeys) {
          if (texto.includes(f)) return "Fauna";
        }
        for (const f of floraKeys) {
          if (texto.includes(f)) return "Flora";
        }
        return null;
      }

      async function obtenerUbicacion(lat, lon) {
        try {
          const response = await fetch(
            `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=es`
          );
          const data = await response.json();

          let ubicacion = [];
          if (data.locality) ubicacion.push(data.locality);
          if (data.principalSubdivision)
            ubicacion.push(data.principalSubdivision);
          if (data.countryName) ubicacion.push(data.countryName);

          return ubicacion.length > 0
            ? ubicacion.join(", ")
            : "Ubicación no identificada";
        } catch (error) {
          console.error("Error al obtener ubicación:", error);
          return "Error al obtener ubicación";
        }
      }

      imagenInput.addEventListener("change", () => {
        if (imagenInput.files.length > 0) {
          btnAnalizar.disabled = false;
          resultadoDiv.innerHTML = "";
          const reader = new FileReader();
          reader.onload = (e) => {
            base64Image = e.target.result.split(",")[1];
            resultadoDiv.innerHTML = `<img src="${e.target.result}" alt="Imagen subida" />`;
          };
          reader.readAsDataURL(imagenInput.files[0]);
        } else {
          btnAnalizar.disabled = true;
          base64Image = "";
          resultadoDiv.innerHTML = "";
        }
      });

      btnAnalizar.addEventListener("click", () => {
        if (!base64Image) return;

        resultadoDiv.innerHTML = `<p><em>Obteniendo ubicación...</em></p>`;

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            async (position) => {
              const lat = position.coords.latitude.toFixed(6);
              const lon = position.coords.longitude.toFixed(6);

              const ubicacionLegible = await obtenerUbicacion(lat, lon);

              resultadoDiv.innerHTML += `<p><strong>Coordenadas:</strong> Latitud ${lat}, Longitud ${lon}</p>`;
              resultadoDiv.innerHTML += `<p><strong>Ubicación:</strong> ${ubicacionLegible}</p>`;
              analizarImagen(lat, lon);
            },
            (error) => {
              resultadoDiv.innerHTML += `<p><strong>Ubicación:</strong> No disponible (${error.message})</p>`;
              analizarImagen(null, null);
            }
          );
        } else {
          resultadoDiv.innerHTML += `<p><strong>Ubicación:</strong> No compatible con este navegador.</p>`;
          analizarImagen(null, null);
        }
      });

      function analizarImagen(lat, lon) {
        resultadoDiv.innerHTML += `<p><em>Analizando imagen...</em></p>`;

        fetch(
          `https://vision.googleapis.com/v1/images:annotate?key=${API_KEY}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              requests: [
                {
                  image: { content: base64Image },
                  features: [
                    { type: "WEB_DETECTION", maxResults: 10 },
                    { type: "LABEL_DETECTION", maxResults: 5 },
                  ],
                },
              ],
            }),
          }
        )
          .then((response) => response.json())
          .then((data) => {
            resultadoDiv.innerHTML += `<img src="data:image/jpeg;base64,${base64Image}" alt="Imagen subida" />`;

            if (data.error) {
              resultadoDiv.innerHTML += `<p><strong>Error:</strong> ${data.error.message}</p>`;
              return;
            }

            const webEntities =
              data.responses[0].webDetection?.webEntities || [];
            const labels = data.responses[0].labelAnnotations || [];

            let nombreDetectado = null;
            let score = 0;

            if (webEntities.length > 0 && webEntities[0].description) {
              const mejor = webEntities.reduce((a, b) =>
                (a.score || 0) > (b.score || 0) ? a : b
              );
              nombreDetectado = mejor.description;
              score = ((mejor.score || 0) * 100).toFixed(1);
            } else if (labels.length > 0 && labels[0].description) {
              const mejorLabel = labels[0];
              nombreDetectado = mejorLabel.description;
              score = ((mejorLabel.score || 0) * 100).toFixed(1);
            }

            if (!nombreDetectado) {
              resultadoDiv.innerHTML += `<p>No se detectaron especies con suficiente certeza.</p>`;
              return;
            }

            const todasDescripciones = [
              ...webEntities.map((w) => w.description),
              ...labels.map((l) => l.description),
            ]
              .filter(Boolean)
              .map((d) => d.toLowerCase());

            const tipoInicial = determinarTipo(
              todasDescripciones.find((desc) => {
                return determinarTipo(desc) !== null;
              }) || ""
            );

            resultadoDiv.innerHTML += `<h3>Resultado más probable:</h3>
              <p><strong>${nombreDetectado}</strong> (confianza: ${score}%)</p>
              <p><strong>Tipo (inicial):</strong> ${
                tipoInicial || "Desconocido"
              }</p>
              <p><em>Buscando información adicional...</em></p>`;

            buscarEnWikipedia(nombreDetectado, "es")
              .then(async (info) => {
                const tipoWikipedia = determinarTipoDesdeExtracto(info.extract);

                // Obtener nombre científico desde HTML
                const nombreCientificoHTML =
                  await obtenerNombreCientificoDesdeHTML(
                    info.title || nombreDetectado
                  );

                mostrarDescripcion(
                  nombreDetectado,
                  { ...info, nombreCientificoHTML },
                  "es",
                  tipoWikipedia || tipoInicial
                );
              })
              .catch(() => {
                buscarEnWikipedia(nombreDetectado, "en")
                  .then((info) => {
                    traducir(info.extract).then((descripcionTraducida) => {
                      info.extract = descripcionTraducida;
                      const tipoWikipedia = determinarTipoDesdeExtracto(
                        info.extract
                      );
                      mostrarDescripcion(
                        nombreDetectado,
                        info,
                        "es",
                        tipoWikipedia || tipoInicial
                      );
                    });
                  })
                  .catch(() => {
                    resultadoDiv.innerHTML += `
                      <p><strong>No se encontró información en Wikipedia.</strong></p>
                      <p><a href="https://www.google.com/search?q=${encodeURIComponent(
                        nombreDetectado
                      )}" target="_blank">🔎 Buscar "${nombreDetectado}" en Google</a></p>
                    `;
                  });
              });
          })
          .catch((err) => {
            console.error("Error al analizar la imagen:", err);
            resultadoDiv.innerHTML += `<p>Error al analizar la imagen: ${err}</p>`;
          });
      }

      function buscarEnWikipedia(nombre, idioma) {
        return fetch(
          `https://${idioma}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(
            nombre
          )}`
        ).then((res) => {
          if (!res.ok) throw new Error("No encontrado");
          return res.json();
        });
      }

      async function traducir(texto) {
        try {
          const textoCorto =
            texto.length > 500 ? texto.substring(0, 500) : texto;
          const res = await fetch(
            `https://api.mymemory.translated.net/get?q=${encodeURIComponent(
              textoCorto
            )}&langpair=en|es`
          );
          const data = await res.json();
          return data.responseData.translatedText;
        } catch (e) {
          return texto;
        }
      }

      function obtenerNombreComunDesdeExtracto(extract, nombreCientifico) {
        if (!extract) return nombreCientifico || "No disponible";

        const primeraOracion = extract.split(".")[0];

        let regex =
          /^(La|El|Los|Las|Un|Una)?\s*([\w\sáéíóúüñ\-]+?),?\s*(también llamada|es una especie de|es un|es una|es el|es la|es los|es las)/i;
        let match = primeraOracion.match(regex);
        if (match && match[2]) {
          return match[2].trim();
        }

        const palabras = primeraOracion.split(/\s+/);
        for (let palabra of palabras) {
          if (
            /^[A-ZÁÉÍÓÚÜÑ]/.test(palabra) &&
            !["La", "El", "Los", "Las", "Un", "Una"].includes(palabra)
          ) {
            return palabra.replace(/[.,;:()"]/g, "");
          }
        }

        return nombreCientifico || "No disponible";
      }

      async function obtenerNombreCientificoDesdeHTML(titulo) {
        try {
          const response = await fetch(
            `https://es.wikipedia.org/wiki/${encodeURIComponent(titulo)}`
          );
          if (!response.ok) throw new Error("No encontrado");

          const html = await response.text();

          const regex =
            /<h1[^>]*id="firstHeading"[^>]*>.*?<span class="mw-page-title-main">([^<]+)<\/span>.*?<\/h1>/i;
          const match = html.match(regex);

          if (match && match[1]) {
            return match[1].trim();
          } else {
            return "No disponible";
          }
        } catch (e) {
          console.error("Error al obtener nombre científico desde HTML:", e);
          return "No disponible";
        }
      }

      function mostrarDescripcion(nombre, data, idioma, tipoFinal) {
        const nombreCientifico = data.nombreCientificoHTML || "No disponible";

        const nombreComun = obtenerNombreComunDesdeExtracto(
          data.extract,
          nombre
        );

        const descripcionCorta = data.extract
          ? data.extract.split(".")[0] + "."
          : "No hay descripción disponible.";

        resultadoDiv.innerHTML += `
          <h4>Información de Wikipedia:</h4>
          <p><strong>Nombre común:</strong> ${nombreComun}</p>
          <p><strong>Nombre científico:</strong> ${nombreCientifico}</p>
          <p><strong>Tipo (ajustado):</strong> ${tipoFinal || "Desconocido"}</p>
          <p>${descripcionCorta}</p>
        `;
      }
    </script>
  </body>
</html>
